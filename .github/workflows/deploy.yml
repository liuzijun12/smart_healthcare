name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: å¼€å§‹éƒ¨ç½²
        run: echo "ğŸš€ å¼€å§‹éƒ¨ç½²æ™ºèƒ½åŒ»ç–—ç³»ç»Ÿ..."
        
      - name: é€šè¿‡ SSH è¿æ¥æœåŠ¡å™¨å¹¶éƒ¨ç½²
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            
            echo "=========================================="
            echo "  æ™ºèƒ½åŒ»ç–—ç³»ç»Ÿ - è‡ªåŠ¨åŒ–éƒ¨ç½²"
            echo "=========================================="
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.DEPLOY_PATH || '/data/lzj/smart_healthcare' }}
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch --all
            git reset --hard origin/main || git reset --hard origin/master
            git pull origin main || git pull origin master
            
            # è¿›å…¥ Docker ç›®å½•
            cd backend/docker
            
            # åœæ­¢ç°æœ‰å®¹å™¨
            echo "â¸ï¸  åœæ­¢ç°æœ‰å®¹å™¨..."
            docker-compose down
            
            # æ„å»ºåç«¯é•œåƒ
            echo "ğŸ”¨ æ„å»ºåç«¯é•œåƒ..."
            cd ..
            docker build -t smart_healthcare_backend:latest -f Dockerfile .
            
            # æ„å»ºå‰ç«¯é•œåƒ
            echo "ğŸ”¨ æ„å»ºå‰ç«¯é•œåƒ..."
            cd ../frontend/smart_healthcare
            docker build -t smart_healthcare_frontend:latest -f Dockerfile .
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f
            
            # å¯åŠ¨æ‰€æœ‰æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            cd ../../backend/docker
            docker-compose up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose ps
            
            echo ""
            echo "=========================================="
            echo "  âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="

